# GUI BLE è¿æ¥é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ› é—®é¢˜æè¿°

GUI çš„ BLE è¿æ¥æŠ¥ "æœªçŸ¥é”™è¯¯"

## ğŸ” æ ¹æœ¬åŸå› 

1. **BLE Manager ç”Ÿå‘½å‘¨æœŸé—®é¢˜**: 
   - `connect_ble_device` å‡½æ•°ä¸­åˆ›å»ºçš„ `BleManager` åœ¨å‡½æ•°ç»“æŸæ—¶è¢«ä¸¢å¼ƒ
   - å¯¼è‡´åº•å±‚è“ç‰™è¿æ¥ç«‹å³æ–­å¼€
   - è®¾å¤‡è™½ç„¶æ˜¾ç¤ºå·²è¿æ¥ï¼Œä½†å®é™…æ— æ³•é€šä¿¡

2. **é”™è¯¯æ¶ˆæ¯ä¸å‹å¥½**:
   - æ‰€æœ‰é”™è¯¯éƒ½æ˜¾ç¤ºè‹±æ–‡ "Failed to..." æ¶ˆæ¯
   - å‰ç«¯ catch å—å°†æ‰€æœ‰é Error ç±»å‹é”™è¯¯æ˜¾ç¤ºä¸º"æœªçŸ¥é”™è¯¯"

## âœ… ä¿®å¤å†…å®¹

### 1. ä¿å­˜ BLE Manager å®ä¾‹

**æ–‡ä»¶**: `apps/dglab-gui-tauri/src-tauri/src/state.rs`

**ä¿®æ”¹**:
```rust
pub struct AppState {
    pub session_manager: Arc<RwLock<SessionManager>>,
    // æ–°å¢ï¼šä¿å­˜ BLE ç®¡ç†å™¨ï¼Œé˜²æ­¢è¿æ¥è¢«ä¸¢å¼ƒ
    pub ble_managers: Arc<RwLock<HashMap<String, BleManager>>>,
}
```

### 2. ä¿®å¤è¿æ¥é€»è¾‘

**æ–‡ä»¶**: `apps/dglab-gui-tauri/src-tauri/src/commands/device.rs`

**ä¿®æ”¹**:
- åœ¨ `connect_ble_device` ä¸­ä¿å­˜ BleManager å®ä¾‹åˆ° AppState
- åœ¨ `disconnect_device` ä¸­æ¸…ç†å¯¹åº”çš„ BleManager
- æ”¹è¿›æ‰€æœ‰é”™è¯¯æ¶ˆæ¯ä¸ºä¸­æ–‡ï¼Œå¹¶æä¾›å…·ä½“çš„é—®é¢˜æç¤º

**å…³é”®ä»£ç **:
```rust
// ä¿å­˜ BLE managerï¼Œé˜²æ­¢è¿æ¥è¢«ä¸¢å¼ƒ
{
    let mut managers = state.ble_managers.write().await;
    managers.insert(device_id.clone(), ble_manager);
}
```

### 3. æ”¹è¿›é”™è¯¯æ¶ˆæ¯

**ä¿®æ”¹å‰**:
```rust
.map_err(|e| format!("Failed to connect to BLE device: {}", e))?
```

**ä¿®æ”¹å**:
```rust
.map_err(|e| {
    let error_msg = format!("è¿æ¥è“ç‰™è®¾å¤‡å¤±è´¥: {}. è¯·ç¡®ä¿è®¾å¤‡å·²å¼€å¯ä¸”åœ¨èŒƒå›´å†…", e);
    tracing::error!("{}", error_msg);
    error_msg
})?
```

## ğŸ“ æµ‹è¯•æ­¥éª¤

### ç¼–è¯‘æµ‹è¯•

```bash
cd apps/dglab-gui-tauri
npm run tauri build
```

### åŠŸèƒ½æµ‹è¯•

1. **å¯åŠ¨ GUI**
   ```bash
   npm run tauri dev
   ```

2. **BLE æ‰«ææµ‹è¯•**
   - ç‚¹å‡» "è®¾å¤‡è¿æ¥"
   - åˆ‡æ¢åˆ° "è“ç‰™ (BLE)" æ ‡ç­¾
   - ç‚¹å‡» "å¼€å§‹æ‰«æ"
   - éªŒè¯ï¼šèƒ½å¤Ÿå‘ç°è®¾å¤‡ï¼ˆ47L121000ï¼‰

3. **BLE è¿æ¥æµ‹è¯•**
   - ç‚¹å‡»è®¾å¤‡å¡ç‰‡ä¸Šçš„ "è¿æ¥" æŒ‰é’®
   - è§‚å¯ŸçŠ¶æ€ï¼š
     - âœ… è¿æ¥ä¸­æç¤º
     - âœ… è¿æ¥æˆåŠŸæç¤º
     - âœ… è·³è½¬åˆ°æ§åˆ¶é¡µé¢
   - éªŒè¯ï¼šè®¾å¤‡ä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®

4. **æ§åˆ¶åŠŸèƒ½æµ‹è¯•**
   - åœ¨æ§åˆ¶é¡µé¢è°ƒæ•´ A/B é€šé“å¼ºåº¦
   - éªŒè¯ï¼šè®¾å¤‡èƒ½å¤Ÿå“åº”æ§åˆ¶å‘½ä»¤
   - ç‚¹å‡» "å¯åŠ¨" æŒ‰é’®
   - éªŒè¯ï¼šè®¾å¤‡èƒ½å¤Ÿæ­£å¸¸è¾“å‡º

5. **æ–­å¼€è¿æ¥æµ‹è¯•**
   - ç‚¹å‡» "æ–­å¼€" æŒ‰é’®
   - éªŒè¯ï¼š
     - âœ… æ–­å¼€è¿æ¥æç¤º
     - âœ… è¿”å›é¦–é¡µæˆ–è®¾å¤‡åˆ—è¡¨
     - âœ… è®¾å¤‡çŠ¶æ€å˜ä¸ºæœªè¿æ¥

6. **é”™è¯¯å¤„ç†æµ‹è¯•**
   - å…³é—­è®¾å¤‡æˆ–ç§»å‡ºèŒƒå›´
   - å°è¯•è¿æ¥
   - éªŒè¯ï¼šæ˜¾ç¤ºå‹å¥½çš„ä¸­æ–‡é”™è¯¯æ¶ˆæ¯

### é¢„æœŸç»“æœ

#### æˆåŠŸåœºæ™¯
```
âœ“ è“ç‰™æ‰«ææˆåŠŸ
âœ“ å‘ç°è®¾å¤‡ï¼š47L121000
âœ“ è¿æ¥ä¸­...
âœ“ è®¾å¤‡å·²è¿æ¥
âœ“ æˆåŠŸè·³è½¬åˆ°æ§åˆ¶é¡µé¢
âœ“ æ§åˆ¶å‘½ä»¤å“åº”æ­£å¸¸
âœ“ æ–­å¼€è¿æ¥æˆåŠŸ
```

#### é”™è¯¯åœºæ™¯ï¼ˆå‹å¥½æç¤ºï¼‰
```
âŒ åˆ›å»ºè“ç‰™ç®¡ç†å™¨å¤±è´¥: [é”™è¯¯è¯¦æƒ…]. è¯·æ£€æŸ¥è“ç‰™æ˜¯å¦å·²å¯ç”¨
âŒ è¿æ¥è“ç‰™è®¾å¤‡å¤±è´¥: [é”™è¯¯è¯¦æƒ…]. è¯·ç¡®ä¿è®¾å¤‡å·²å¼€å¯ä¸”åœ¨èŒƒå›´å†…
âŒ è®¾å¤‡è¿æ¥å¤±è´¥: [é”™è¯¯è¯¦æƒ…]. è¯·é‡è¯•æˆ–é‡å¯è®¾å¤‡
```

## ğŸ”§ ä¿®å¤çš„å…·ä½“é—®é¢˜

### é—®é¢˜ 1: "æœªçŸ¥é”™è¯¯"
- **åŸå› **: è‹±æ–‡é”™è¯¯æ¶ˆæ¯ + æ³›å‹é”™è¯¯å¤„ç†
- **ä¿®å¤**: ä¸­æ–‡é”™è¯¯æ¶ˆæ¯ + è¯¦ç»†çš„é—®é¢˜æè¿°

### é—®é¢˜ 2: è¿æ¥åç«‹å³æ–­å¼€
- **åŸå› **: BleManager è¢«ä¸¢å¼ƒ
- **ä¿®å¤**: ä¿å­˜åˆ° AppState ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸä¸è®¾å¤‡ç»‘å®š

### é—®é¢˜ 3: æ— æ³•æ§åˆ¶è®¾å¤‡
- **åŸå› **: åº•å±‚è¿æ¥å·²æ–­å¼€
- **ä¿®å¤**: ä¿æŒè¿æ¥æ´»è·ƒï¼Œç›´åˆ°æ˜ç¡®æ–­å¼€

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `apps/dglab-gui-tauri/src-tauri/src/state.rs` - åº”ç”¨çŠ¶æ€ï¼ˆæ·»åŠ  ble_managersï¼‰
- `apps/dglab-gui-tauri/src-tauri/src/commands/device.rs` - è®¾å¤‡å‘½ä»¤ï¼ˆä¿®å¤è¿æ¥é€»è¾‘ï¼‰
- `apps/dglab-gui-tauri/src/stores/deviceStore.ts` - å‰ç«¯è®¾å¤‡çŠ¶æ€ï¼ˆé”™è¯¯å¤„ç†ï¼‰

## ğŸš€ éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ
```bash
cd apps/dglab-gui-tauri
npm run tauri dev
```

### ç”Ÿäº§æ„å»º
```bash
# Linux
npm run tauri build

# Windows
npm run tauri build

# macOS
npm run tauri build -- --target universal-apple-darwin
```

### éªŒè¯ä¿®å¤
1. ä½¿ç”¨çœŸå®è®¾å¤‡æµ‹è¯•ï¼ˆ47L121000ï¼‰
2. éªŒè¯è¿æ¥ç¨³å®šæ€§ï¼ˆè‡³å°‘ä¿æŒ 5 åˆ†é’Ÿï¼‰
3. éªŒè¯æ§åˆ¶åŠŸèƒ½æ­£å¸¸
4. éªŒè¯é”™è¯¯æç¤ºå‹å¥½

## ğŸ’¡ æŠ€æœ¯ç»†èŠ‚

### BLE Manager ç”Ÿå‘½å‘¨æœŸ

**ä¿®å¤å‰**:
```
connect_ble_device() {
    let manager = BleManager::new();  // åˆ›å»º
    let device = manager.connect();   // è¿æ¥
    // ... å‡½æ•°ç»“æŸ
}  // <- manager è¢« dropï¼Œè¿æ¥æ–­å¼€ï¼
```

**ä¿®å¤å**:
```
connect_ble_device() {
    let manager = BleManager::new();  // åˆ›å»º
    let device = manager.connect();   // è¿æ¥
    state.ble_managers.insert(id, manager);  // ä¿å­˜ï¼
}  // <- manager ä»ç„¶å­˜æ´»ï¼Œè¿æ¥ä¿æŒ
```

### é”™è¯¯æ¶ˆæ¯æ˜ å°„

| åŸå§‹é”™è¯¯ | ç”¨æˆ·å‹å¥½æ¶ˆæ¯ |
|---------|------------|
| Failed to create BLE manager | åˆ›å»ºè“ç‰™ç®¡ç†å™¨å¤±è´¥. è¯·æ£€æŸ¥è“ç‰™æ˜¯å¦å·²å¯ç”¨ |
| Failed to connect to BLE device | è¿æ¥è“ç‰™è®¾å¤‡å¤±è´¥. è¯·ç¡®ä¿è®¾å¤‡å·²å¼€å¯ä¸”åœ¨èŒƒå›´å†… |
| Failed to connect device | è®¾å¤‡è¿æ¥å¤±è´¥. è¯·é‡è¯•æˆ–é‡å¯è®¾å¤‡ |
| Device not found | è®¾å¤‡æœªæ‰¾åˆ° |

## âœ… éªŒè¯æ¸…å•

- [ ] ä»£ç ç¼–è¯‘é€šè¿‡
- [ ] BLE æ‰«æåŠŸèƒ½æ­£å¸¸
- [ ] BLE è¿æ¥åŠŸèƒ½æ­£å¸¸
- [ ] è¿æ¥ä¿æŒç¨³å®šï¼ˆ5+ åˆ†é’Ÿï¼‰
- [ ] è®¾å¤‡æ§åˆ¶åŠŸèƒ½æ­£å¸¸
- [ ] æ–­å¼€è¿æ¥åŠŸèƒ½æ­£å¸¸
- [ ] é”™è¯¯æ¶ˆæ¯å‹å¥½ä¸”å‡†ç¡®
- [ ] æ—¥å¿—è¾“å‡ºè¯¦ç»†ä¸”æœ‰ç”¨
- [ ] æ²¡æœ‰å†…å­˜æ³„æ¼
- [ ] é‡è¿åŠŸèƒ½æ­£å¸¸

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **æµ‹è¯•éªŒè¯**: åœ¨ Windows ç¯å¢ƒä½¿ç”¨çœŸå®è®¾å¤‡æµ‹è¯•
2. **æ€§èƒ½ç›‘æ§**: è§‚å¯Ÿé•¿æ—¶é—´è¿æ¥çš„å†…å­˜ä½¿ç”¨
3. **ç”¨æˆ·åé¦ˆ**: æ”¶é›†å®é™…ä½¿ç”¨ä¸­çš„é—®é¢˜
4. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç”¨æˆ·æ‰‹å†Œä¸­çš„æ•…éšœæ’é™¤éƒ¨åˆ†

## ğŸ“ æäº¤ä¿¡æ¯

```
fix: ä¿®å¤ GUI BLE è¿æ¥ "æœªçŸ¥é”™è¯¯" é—®é¢˜

- ä¿å­˜ BleManager å®ä¾‹åˆ° AppStateï¼Œé˜²æ­¢è¿æ¥è¢«ä¸¢å¼ƒ
- åœ¨æ–­å¼€è¿æ¥æ—¶æ¸…ç† BLE manager
- æ”¹è¿›æ‰€æœ‰é”™è¯¯æ¶ˆæ¯ä¸ºä¸­æ–‡ï¼Œæä¾›å…·ä½“çš„é—®é¢˜æç¤º
- æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ç”¨äºè°ƒè¯•

ä¿®å¤çš„é—®é¢˜:
- è¿æ¥åç«‹å³æ–­å¼€
- æ˜¾ç¤º "æœªçŸ¥é”™è¯¯"
- æ— æ³•æ§åˆ¶è®¾å¤‡

æµ‹è¯•: éœ€è¦åœ¨çœŸå® Windows ç¯å¢ƒæµ‹è¯•
```

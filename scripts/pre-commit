#!/bin/bash
# DG-LAB Pre-commit Hook
# åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç æ ¼å¼å’Œè´¨é‡

set -e

echo "ğŸ” Running pre-commit checks..."

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ£€æŸ¥æ˜¯å¦æœ‰ Rust æ–‡ä»¶å˜æ›´
rust_files_changed=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)

if [ -n "$rust_files_changed" ]; then
    echo "ğŸ“ Rust æ–‡ä»¶å·²æ›´æ”¹ï¼Œè¿è¡Œæ£€æŸ¥..."
    
    # 1. ä»£ç æ ¼å¼æ£€æŸ¥
    echo "  â”œâ”€ æ£€æŸ¥ä»£ç æ ¼å¼ (rustfmt)..."
    if ! cargo fmt --all -- --check; then
        echo -e "${RED}âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼${NC}"
        echo -e "${YELLOW}ğŸ’¡ è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š${NC}"
        echo "   cargo fmt --all"
        echo ""
        echo -e "${YELLOW}æˆ–è€…è·³è¿‡æ­¤æ£€æŸ¥ï¼ˆä¸æ¨èï¼‰ï¼š${NC}"
        echo "   git commit --no-verify"
        exit 1
    fi
    echo -e "${GREEN}  âœ“ ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡${NC}"
    
    # 2. Clippy æ£€æŸ¥
    echo "  â”œâ”€ è¿è¡Œ Clippy æ£€æŸ¥..."
    if ! cargo clippy --all-targets --all-features -- -D warnings 2>&1 | grep -v "Checking\|Compiling\|Finished"; then
        echo -e "${RED}âŒ Clippy å‘ç°è­¦å‘Šæˆ–é”™è¯¯ï¼${NC}"
        echo -e "${YELLOW}ğŸ’¡ è¯·ä¿®å¤ Clippy è­¦å‘Šåå†æäº¤${NC}"
        echo ""
        echo -e "${YELLOW}æˆ–è€…è·³è¿‡æ­¤æ£€æŸ¥ï¼ˆä¸æ¨èï¼‰ï¼š${NC}"
        echo "   git commit --no-verify"
        exit 1
    fi
    echo -e "${GREEN}  âœ“ Clippy æ£€æŸ¥é€šè¿‡${NC}"
    
    # 3. å¿«é€Ÿç¼–è¯‘æ£€æŸ¥
    echo "  â””â”€ æ£€æŸ¥æ˜¯å¦èƒ½ç¼–è¯‘..."
    if ! cargo check --workspace --quiet 2>&1 | grep -v "Checking\|Finished"; then
        echo -e "${RED}âŒ ä»£ç æ— æ³•ç¼–è¯‘ï¼${NC}"
        exit 1
    fi
    echo -e "${GREEN}  âœ“ ç¼–è¯‘æ£€æŸ¥é€šè¿‡${NC}"
else
    echo "â„¹ï¸  æ²¡æœ‰ Rust æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡ Rust æ£€æŸ¥"
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ TypeScript/JavaScript æ–‡ä»¶å˜æ›´
ts_files_changed=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep "apps/dglab-gui-tauri" || true)

if [ -n "$ts_files_changed" ]; then
    echo "ğŸ“ TypeScript æ–‡ä»¶å·²æ›´æ”¹ï¼Œè¿è¡Œæ£€æŸ¥..."
    
    # TypeScript ç±»å‹æ£€æŸ¥
    echo "  â””â”€ æ£€æŸ¥ TypeScript ç±»å‹..."
    if ! (cd apps/dglab-gui-tauri && npm run type-check); then
        echo -e "${RED}âŒ TypeScript ç±»å‹æ£€æŸ¥å¤±è´¥ï¼${NC}"
        exit 1
    fi
    echo -e "${GREEN}  âœ“ TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡${NC}"
else
    echo "â„¹ï¸  æ²¡æœ‰ TypeScript æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡ TypeScript æ£€æŸ¥"
fi

echo -e "${GREEN}âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå‡†å¤‡æäº¤...${NC}"
exit 0
